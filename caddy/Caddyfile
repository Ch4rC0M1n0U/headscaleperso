# ###############################################################################
# CADDY - Reverse Proxy Sécurisé pour Headscale + Headplane
# Configuration durcie - minimise le fingerprinting
# ###############################################################################

static.45.211.62.46.clients.your-server.de {
    # Logs d'accès (format JSON pour CrowdSec)
    log {
        output file /data/access.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }

    # =========================================================================
    # HEADERS DE SÉCURITÉ - Masquer l'identité du serveur
    # =========================================================================
    header {
        # HSTS strict
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prévenir le clickjacking
        X-Frame-Options "DENY"
        # Prévenir le sniffing MIME
        X-Content-Type-Options "nosniff"
        # XSS Protection
        X-XSS-Protection "1; mode=block"
        # Referrer Policy strict
        Referrer-Policy "no-referrer"
        # Supprimer TOUS les headers révélateurs
        -Server
        -X-Powered-By
        -Via
    }

    # =========================================================================
    # BLOQUER LES ENDPOINTS D'IDENTIFICATION HEADSCALE
    # Ces pages révèlent que c'est un serveur Headscale
    # =========================================================================
    
    # Pages d'aide par OS - retourne 404 générique
    @help_pages path /windows /windows/* /apple /apple/* /linux /linux/*
    handle @help_pages {
        respond "Not Found" 404
    }
    
    # Bloquer l'accès aux infos de version/health publiques
    @info_endpoints path /health /version /metrics
    handle @info_endpoints {
        respond "Not Found" 404
    }
    
    # API sans auth - retourner 404 au lieu de 401 (évite fingerprint)
    @api_noauth {
        path /api/*
        not header Authorization *
    }
    handle @api_noauth {
        respond "Not Found" 404
    }

    # =========================================================================
    # ROUTE /admin/* vers Headplane (interface d'administration)
    # =========================================================================
    handle /admin* {
        reverse_proxy headplane:3000 {
            header_down -Server
            header_down -X-Powered-By
        }
    }

    # =========================================================================
    # ROUTE RACINE - Page générique au lieu de rien
    # =========================================================================
    handle / {
        respond "Service Unavailable" 503
    }

    # =========================================================================
    # ROUTES HEADSCALE LÉGITIMES
    # Seulement ce qui est nécessaire au protocole Tailscale
    # =========================================================================
    handle {
        reverse_proxy headscale:8080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            
            # Supprimer headers révélateurs
            header_down -Server
            header_down -X-Powered-By
        }
    }
}
