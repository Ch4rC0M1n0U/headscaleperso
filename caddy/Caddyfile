# ###############################################################################
# CADDY - Reverse Proxy Sécurisé pour Headscale + Headplane
# Port 8443 - Configuration durcie et camouflée
# ###############################################################################

{
    # Désactiver la page d'admin Caddy
    admin off
    
    # Logs minimaux niveau global
    log {
        level ERROR
    }
}

:8443 {
    # TLS automatique
    tls internal
    
    # Logs d'accès (format JSON pour CrowdSec)
    log {
        output file /data/access.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }

    # =========================================================================
    # HEADERS DE SÉCURITÉ - Ressembler à un service générique
    # =========================================================================
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        # Supprimer TOUS les headers révélateurs
        -Server
        -X-Powered-By
        -Via
    }

    # =========================================================================
    # BLOQUER LES ENDPOINTS D'IDENTIFICATION HEADSCALE
    # Retourne des erreurs génériques pour éviter le fingerprinting
    # =========================================================================
    
    # Pages d'aide par OS - BLOQUÉ
    @help_pages path /windows /windows/* /apple /apple/* /linux /linux/*
    respond @help_pages "Not Found" 404
    
    # Endpoints de monitoring - BLOQUÉ
    @info_endpoints path /health /version /metrics /debug/*
    respond @info_endpoints "Not Found" 404
    
    # Swagger/OpenAPI - BLOQUÉ
    @swagger path /swagger* /api-docs* /openapi*
    respond @swagger "Not Found" 404
    
    # API sans authentification - retourne 404 (pas 401)
    @api_noauth {
        path /api/*
        not header Authorization *
    }
    respond @api_noauth "Not Found" 404

    # =========================================================================
    # HEADPLANE - Interface d'administration (/admin)
    # =========================================================================
    handle /admin* {
        reverse_proxy headplane:3000 {
            header_down -Server
            header_down -X-Powered-By
        }
    }

    # =========================================================================
    # RACINE - Ferme la connexion silencieusement
    # =========================================================================
    respond / "" 204

    # =========================================================================
    # HEADSCALE - Protocole Tailscale uniquement
    # Les vrais clients Tailscale passent ici
    # =========================================================================
    reverse_proxy headscale:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto https
        
        # Supprimer headers révélateurs
        header_down -Server
        header_down -X-Powered-By
    }
}
